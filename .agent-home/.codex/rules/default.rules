# Execpolicy rules for Codex CLI.
# - decision: allow | prompt | forbidden
# - strictest match wins (forbidden > prompt > allow)

prefix_rule(pattern=["curl"], decision="allow")

# Read-only GitHub CLI usage (safe by default)
prefix_rule(pattern=["gh", "issue", ["list", "view"]], decision="allow")
prefix_rule(pattern=["gh", "run", ["list", "view"]], decision="allow")
prefix_rule(pattern=["gh", "workflow", ["list", "view"]], decision="allow")

# Git hooks を無視する commit は禁止
prefix_rule(
    pattern = ["git", "commit", ["-n", "--no-verify"]],
    decision = "forbidden",
    match = [["git", "commit", "-n", "-m", "msg"], ["git", "commit", "--no-verify", "-m", "msg"]],
    not_match = [["git", "commit", "-m", "msg"]],
)

# Git basics are allowed
prefix_rule(
    pattern = ["git", ["add", "commit"]],
    decision = "allow",
    match = [["git", "add", "-A"], ["git", "commit", "-m", "msg"]],
    not_match = [["git", "push", "origin", "main"], ["git", "merge", "main"]],
)

# Git destructive operations: forbidden
prefix_rule(
    pattern = ["git", ["push", "merge", "rebase", "stash", "reset"]],
    decision = "forbidden",
    match = [["git", "push", "origin", "main"], ["git", "rebase", "main"], ["git", "reset", "--hard"]],
    not_match = [["git", "status"], ["git", "commit", "-m", "msg"]],
)
prefix_rule(
    pattern = ["git", "clean"],
    decision = "forbidden",
    match = [["git", "clean", "-fdx"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "branch", "-D"],
    decision = "forbidden",
    match = [["git", "branch", "-D", "some-branch"]],
    not_match = [["git", "branch", "-d", "some-branch"], ["git", "branch"]],
)
prefix_rule(
    pattern = ["git", "tag", ["-d", "--delete"]],
    decision = "forbidden",
    match = [["git", "tag", "-d", "v1.0.0"]],
    not_match = [["git", "tag"], ["git", "tag", "v1.0.0"]],
)
prefix_rule(
    pattern = ["git", "update-ref", ["-d", "--delete"]],
    decision = "forbidden",
    match = [["git", "update-ref", "-d", "refs/heads/main"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "reflog", ["expire", "delete"]],
    decision = "forbidden",
    match = [["git", "reflog", "expire", "--expire=now", "--all"]],
    not_match = [["git", "reflog", "show"]],
)
prefix_rule(
    pattern = ["git", "prune"],
    decision = "forbidden",
    match = [["git", "prune"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", ["filter-branch", "filter-repo"]],
    decision = "forbidden",
    match = [["git", "filter-branch", "--", "--all"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "checkout", ["-f", "--force"]],
    decision = "forbidden",
    match = [["git", "checkout", "-f", "main"]],
    not_match = [["git", "checkout", "main"]],
)
prefix_rule(
    pattern = ["git", "switch", ["-f", "--force"]],
    decision = "forbidden",
    match = [["git", "switch", "--force", "main"]],
    not_match = [["git", "switch", "main"]],
)
prefix_rule(
    pattern = ["git", "gc", "--prune=now"],
    decision = "forbidden",
    match = [["git", "gc", "--prune=now"]],
    not_match = [["git", "gc"]],
)

# Git operations that require explicit user confirmation: prompt
prefix_rule(
    pattern = ["git", "pull"],
    decision = "prompt",
    match = [["git", "pull"]],
    not_match = [["git", "fetch"], ["git", "status"]],
)
prefix_rule(
    pattern = ["git", "commit", ["--amend", "--fixup", "--squash"]],
    decision = "prompt",
    match = [["git", "commit", "--amend"]],
    not_match = [["git", "commit", "-m", "msg"]],
)
prefix_rule(
    pattern = ["git", "rm"],
    decision = "prompt",
    match = [["git", "rm", "-r", "path"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "restore"],
    decision = "prompt",
    match = [["git", "restore", "."]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "remote", ["remove", "set-url", "rename", "prune"]],
    decision = "prompt",
    match = [["git", "remote", "set-url", "origin", "https://example.com/repo.git"]],
    not_match = [["git", "remote", "-v"]],
)
prefix_rule(
    pattern = ["git", "fetch", ["-p", "--prune"]],
    decision = "prompt",
    match = [["git", "fetch", "--prune"]],
    not_match = [["git", "fetch"]],
)
prefix_rule(
    pattern = ["git", "gc"],
    decision = "prompt",
    match = [["git", "gc"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "branch", ["-d", "--delete"]],
    decision = "prompt",
    match = [["git", "branch", "-d", "some-branch"]],
    not_match = [["git", "branch"]],
)

# GitHub CLI: destructive operations forbidden, state changes prompt
prefix_rule(
    pattern = ["gh", "api"],
    decision = "prompt",
    match = [["gh", "api", "repos/{owner}/{repo}"]],
    not_match = [["gh", "issue", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "repo", "delete"],
    decision = "forbidden",
    match = [["gh", "repo", "delete", "OWNER/REPO", "--yes"]],
    not_match = [["gh", "repo", "view"]],
)
prefix_rule(
    pattern = ["gh", "repo", ["rename", "archive", "unarchive", "edit", "sync"]],
    decision = "prompt",
    match = [["gh", "repo", "archive", "--yes"]],
    not_match = [["gh", "repo", "view"]],
)
prefix_rule(
    pattern = ["gh", "pr", "merge"],
    decision = "prompt",
    match = [["gh", "pr", "merge", "123"]],
    not_match = [["gh", "pr", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "issue", "transfer"],
    decision = "prompt",
    match = [["gh", "issue", "transfer", "123", "OWNER/OTHER_REPO"]],
    not_match = [["gh", "issue", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "issue", "delete"],
    decision = "forbidden",
    match = [["gh", "issue", "delete", "123", "--yes"]],
    not_match = [["gh", "issue", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "release", ["delete", "delete-asset"]],
    decision = "forbidden",
    match = [["gh", "release", "delete", "v1.0.0", "--yes"]],
    not_match = [["gh", "release", "view", "v1.0.0"]],
)
prefix_rule(
    pattern = ["gh", "run", ["cancel", "rerun"]],
    decision = "prompt",
    match = [["gh", "run", "cancel", "123"]],
    not_match = [["gh", "run", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "run", "delete"],
    decision = "forbidden",
    match = [["gh", "run", "delete", "123"]],
    not_match = [["gh", "run", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "workflow", ["disable", "enable", "run"]],
    decision = "prompt",
    match = [["gh", "workflow", "disable", "ci.yml"]],
    not_match = [["gh", "workflow", "view", "ci.yml"]],
)
prefix_rule(
    pattern = ["gh", "cache", "delete"],
    decision = "forbidden",
    match = [["gh", "cache", "delete", "--all"]],
    not_match = [["gh", "cache", "list"]],
)
prefix_rule(
    pattern = ["gh", "secret", "set"],
    decision = "prompt",
    match = [["gh", "secret", "set", "NAME", "--body", "VALUE"]],
    not_match = [["gh", "secret", "list"]],
)
prefix_rule(
    pattern = ["gh", "secret", "delete"],
    decision = "forbidden",
    match = [["gh", "secret", "delete", "NAME"]],
    not_match = [["gh", "secret", "list"]],
)
prefix_rule(
    pattern = ["gh", "variable", "set"],
    decision = "prompt",
    match = [["gh", "variable", "set", "NAME", "--body", "VALUE"]],
    not_match = [["gh", "variable", "list"]],
)
prefix_rule(
    pattern = ["gh", "variable", "delete"],
    decision = "forbidden",
    match = [["gh", "variable", "delete", "NAME"]],
    not_match = [["gh", "variable", "list"]],
)
prefix_rule(
    pattern = ["gh", "project", ["delete", "field-delete", "item-delete"]],
    decision = "forbidden",
    match = [["gh", "project", "delete", "1"]],
    not_match = [["gh", "project", "view", "1"]],
)
prefix_rule(
    pattern = ["gh", "gist", "delete"],
    decision = "forbidden",
    match = [["gh", "gist", "delete", "5b0e0062eb8e9654adad7bb1d81cc75f"]],
    not_match = [["gh", "gist", "view", "5b0e0062eb8e9654adad7bb1d81cc75f"]],
)
prefix_rule(
    pattern = ["gh", ["codespace", "cs"], "delete"],
    decision = "forbidden",
    match = [["gh", "codespace", "delete", "--codespace", "CODESPACE"]],
    not_match = [["gh", "codespace", "list"]],
)
prefix_rule(
    pattern = ["gh", "repo", "deploy-key", "delete"],
    decision = "forbidden",
    match = [["gh", "repo", "deploy-key", "delete", "123"]],
    not_match = [["gh", "repo", "deploy-key", "list"]],
)
prefix_rule(
    pattern = ["gh", "repo", "autolink", "delete"],
    decision = "forbidden",
    match = [["gh", "repo", "autolink", "delete", "1"]],
    not_match = [["gh", "repo", "autolink", "list"]],
)
prefix_rule(
    pattern = ["gh", "ssh-key", "delete"],
    decision = "forbidden",
    match = [["gh", "ssh-key", "delete", "123"]],
    not_match = [["gh", "ssh-key", "list"]],
)
prefix_rule(
    pattern = ["gh", "gpg-key", "delete"],
    decision = "forbidden",
    match = [["gh", "gpg-key", "delete", "123"]],
    not_match = [["gh", "gpg-key", "list"]],
)
