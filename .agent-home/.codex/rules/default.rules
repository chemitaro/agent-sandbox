# Execpolicy rules for Codex CLI.
# - decision: allow | prompt | forbidden
# - strictest match wins (forbidden > prompt > allow)

prefix_rule(pattern=["curl"], decision="allow", justification="調査/ダウンロード等で必要になるため許可（機密情報の送信は禁止）。")

# Read-only GitHub CLI usage (safe by default)
prefix_rule(pattern=["gh", "issue", ["list", "view"]], decision="allow", justification="Issue の閲覧のみを許可（状態変更しない）。")
prefix_rule(pattern=["gh", "run", ["list", "view"]], decision="allow", justification="Actions Run の閲覧のみを許可（状態変更しない）。")
prefix_rule(pattern=["gh", "workflow", ["list", "view"]], decision="allow", justification="Workflow の閲覧のみを許可（状態変更しない）。")

# Git hooks を無視する commit は禁止
prefix_rule(
    pattern = ["git", "commit", ["-n", "--no-verify"]],
    decision = "forbidden",
    justification = "フックを無視するコミットは禁止（品質/安全チェックを回避するため）。",
    match = [["git", "commit", "-n", "-m", "msg"], ["git", "commit", "--no-verify", "-m", "msg"]],
    not_match = [["git", "commit", "-m", "msg"]],
)

# Git basics are allowed
prefix_rule(
    pattern = ["git", ["add", "commit"]],
    decision = "allow",
    justification = "基本的なステージ/コミットを許可（実行はユーザー指示/手順がある場合のみ）。",
    match = [["git", "add", "-A"], ["git", "commit", "-m", "msg"]],
    not_match = [["git", "push", "origin", "main"], ["git", "merge", "main"]],
)

# Git destructive operations: forbidden
prefix_rule(
    pattern = ["git", ["push", "merge", "rebase", "stash", "reset"]],
    decision = "forbidden",
    justification = "履歴や作業状態に大きな影響があるため禁止。",
    match = [["git", "push", "origin", "main"], ["git", "rebase", "main"], ["git", "reset", "--hard"]],
    not_match = [["git", "status"], ["git", "commit", "-m", "msg"]],
)
prefix_rule(
    pattern = ["git", "clean"],
    decision = "forbidden",
    justification = "追跡外ファイルの削除は復元困難なため禁止。",
    match = [["git", "clean", "-fdx"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "branch", "-D"],
    decision = "forbidden",
    justification = "ブランチ強制削除は不可逆なため禁止。",
    match = [["git", "branch", "-D", "some-branch"]],
    not_match = [["git", "branch", "-d", "some-branch"], ["git", "branch"]],
)
prefix_rule(
    pattern = ["git", "tag", ["-d", "--delete"]],
    decision = "forbidden",
    justification = "タグ削除は参照切れを招くため禁止。",
    match = [["git", "tag", "-d", "v1.0.0"]],
    not_match = [["git", "tag"], ["git", "tag", "v1.0.0"]],
)
prefix_rule(
    pattern = ["git", "update-ref", ["-d", "--delete"]],
    decision = "forbidden",
    justification = "参照の直接操作は危険なため禁止。",
    match = [["git", "update-ref", "-d", "refs/heads/main"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "reflog", ["expire", "delete"]],
    decision = "forbidden",
    justification = "reflog を削除すると復旧手段を失うため禁止。",
    match = [["git", "reflog", "expire", "--expire=now", "--all"]],
    not_match = [["git", "reflog", "show"]],
)
prefix_rule(
    pattern = ["git", "prune"],
    decision = "forbidden",
    justification = "オブジェクト削除は復元困難なため禁止。",
    match = [["git", "prune"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", ["filter-branch", "filter-repo"]],
    decision = "forbidden",
    justification = "履歴書き換えは影響範囲が大きいため禁止。",
    match = [["git", "filter-branch", "--", "--all"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "checkout", ["-f", "--force"]],
    decision = "forbidden",
    justification = "強制 checkout は変更を失う可能性があるため禁止。",
    match = [["git", "checkout", "-f", "main"]],
    not_match = [["git", "checkout", "main"]],
)
prefix_rule(
    pattern = ["git", "switch", ["-f", "--force"]],
    decision = "forbidden",
    justification = "強制 switch は変更を失う可能性があるため禁止。",
    match = [["git", "switch", "--force", "main"]],
    not_match = [["git", "switch", "main"]],
)
prefix_rule(
    pattern = ["git", "gc", "--prune=now"],
    decision = "forbidden",
    justification = "即時 prune は復元困難なため禁止。",
    match = [["git", "gc", "--prune=now"]],
    not_match = [["git", "gc"]],
)

# Git operations that require explicit user confirmation: prompt
prefix_rule(
    pattern = ["git", "pull"],
    decision = "prompt",
    justification = "マージ/競合が発生し得るため事前確認。",
    match = [["git", "pull"]],
    not_match = [["git", "fetch"], ["git", "status"]],
)
prefix_rule(
    pattern = ["git", "commit", ["--amend", "--fixup", "--squash"]],
    decision = "prompt",
    justification = "履歴の修正を伴うため事前確認。",
    match = [["git", "commit", "--amend"]],
    not_match = [["git", "commit", "-m", "msg"]],
)
prefix_rule(
    pattern = ["git", "rm"],
    decision = "prompt",
    justification = "ファイル削除を伴うため事前確認。",
    match = [["git", "rm", "-r", "path"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "restore"],
    decision = "prompt",
    justification = "作業内容を破棄し得るため事前確認。",
    match = [["git", "restore", "."]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "remote", ["remove", "set-url", "rename", "prune"]],
    decision = "prompt",
    justification = "リモート設定変更は影響が大きいため事前確認。",
    match = [["git", "remote", "set-url", "origin", "https://example.com/repo.git"]],
    not_match = [["git", "remote", "-v"]],
)
prefix_rule(
    pattern = ["git", "fetch", ["-p", "--prune"]],
    decision = "prompt",
    justification = "追跡ブランチ削除が発生し得るため事前確認。",
    match = [["git", "fetch", "--prune"]],
    not_match = [["git", "fetch"]],
)
prefix_rule(
    pattern = ["git", "gc"],
    decision = "prompt",
    justification = "リポジトリメンテは影響があるため事前確認。",
    match = [["git", "gc"]],
    not_match = [["git", "status"]],
)
prefix_rule(
    pattern = ["git", "branch", ["-d", "--delete"]],
    decision = "prompt",
    justification = "ブランチ削除は影響があるため事前確認。",
    match = [["git", "branch", "-d", "some-branch"]],
    not_match = [["git", "branch"]],
)

# GitHub CLI: destructive operations forbidden, state changes prompt
prefix_rule(
    pattern = ["gh", "api"],
    decision = "prompt",
    justification = "API 呼び出しは状態変更の可能性があるため事前確認。",
    match = [["gh", "api", "repos/{owner}/{repo}"]],
    not_match = [["gh", "issue", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "repo", "delete"],
    decision = "forbidden",
    justification = "リポジトリ削除は不可逆なため禁止。",
    match = [["gh", "repo", "delete", "OWNER/REPO", "--yes"]],
    not_match = [["gh", "repo", "view"]],
)
prefix_rule(
    pattern = ["gh", "repo", ["rename", "archive", "unarchive", "edit", "sync"]],
    decision = "prompt",
    justification = "リポジトリ設定/状態変更を伴うため事前確認。",
    match = [["gh", "repo", "archive", "--yes"]],
    not_match = [["gh", "repo", "view"]],
)
prefix_rule(
    pattern = ["gh", "pr", "merge"],
    decision = "prompt",
    justification = "PR マージはリポジトリを変更するため事前確認。",
    match = [["gh", "pr", "merge", "123"]],
    not_match = [["gh", "pr", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "issue", "transfer"],
    decision = "prompt",
    justification = "Issue の移動は影響が大きいため事前確認。",
    match = [["gh", "issue", "transfer", "123", "OWNER/OTHER_REPO"]],
    not_match = [["gh", "issue", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "issue", "delete"],
    decision = "forbidden",
    justification = "Issue 削除は不可逆なため禁止。",
    match = [["gh", "issue", "delete", "123", "--yes"]],
    not_match = [["gh", "issue", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "release", ["delete", "delete-asset"]],
    decision = "forbidden",
    justification = "Release/asset 削除は不可逆なため禁止。",
    match = [["gh", "release", "delete", "v1.0.0", "--yes"]],
    not_match = [["gh", "release", "view", "v1.0.0"]],
)
prefix_rule(
    pattern = ["gh", "run", ["cancel", "rerun"]],
    decision = "prompt",
    justification = "CI の停止/再実行は影響があるため事前確認。",
    match = [["gh", "run", "cancel", "123"]],
    not_match = [["gh", "run", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "run", "delete"],
    decision = "forbidden",
    justification = "Run 削除は不可逆なため禁止。",
    match = [["gh", "run", "delete", "123"]],
    not_match = [["gh", "run", "view", "123"]],
)
prefix_rule(
    pattern = ["gh", "workflow", ["disable", "enable", "run"]],
    decision = "prompt",
    justification = "Workflow の実行/切替は影響が大きいため事前確認。",
    match = [["gh", "workflow", "disable", "ci.yml"]],
    not_match = [["gh", "workflow", "view", "ci.yml"]],
)
prefix_rule(
    pattern = ["gh", "cache", "delete"],
    decision = "forbidden",
    justification = "Cache 削除は復元できないため禁止。",
    match = [["gh", "cache", "delete", "--all"]],
    not_match = [["gh", "cache", "list"]],
)
prefix_rule(
    pattern = ["gh", "secret", "set"],
    decision = "prompt",
    justification = "Secrets の変更は高リスクなため事前確認。",
    match = [["gh", "secret", "set", "NAME", "--body", "VALUE"]],
    not_match = [["gh", "secret", "list"]],
)
prefix_rule(
    pattern = ["gh", "secret", "delete"],
    decision = "forbidden",
    justification = "Secrets 削除は不可逆なため禁止。",
    match = [["gh", "secret", "delete", "NAME"]],
    not_match = [["gh", "secret", "list"]],
)
prefix_rule(
    pattern = ["gh", "variable", "set"],
    decision = "prompt",
    justification = "Variables の変更は影響があるため事前確認。",
    match = [["gh", "variable", "set", "NAME", "--body", "VALUE"]],
    not_match = [["gh", "variable", "list"]],
)
prefix_rule(
    pattern = ["gh", "variable", "delete"],
    decision = "forbidden",
    justification = "Variables 削除は不可逆なため禁止。",
    match = [["gh", "variable", "delete", "NAME"]],
    not_match = [["gh", "variable", "list"]],
)
prefix_rule(
    pattern = ["gh", "project", ["delete", "field-delete", "item-delete"]],
    decision = "forbidden",
    justification = "Project の削除は不可逆なため禁止。",
    match = [["gh", "project", "delete", "1"]],
    not_match = [["gh", "project", "view", "1"]],
)
prefix_rule(
    pattern = ["gh", "gist", "delete"],
    decision = "forbidden",
    justification = "Gist 削除は不可逆なため禁止。",
    match = [["gh", "gist", "delete", "5b0e0062eb8e9654adad7bb1d81cc75f"]],
    not_match = [["gh", "gist", "view", "5b0e0062eb8e9654adad7bb1d81cc75f"]],
)
prefix_rule(
    pattern = ["gh", ["codespace", "cs"], "delete"],
    decision = "forbidden",
    justification = "Codespace 削除は不可逆なため禁止。",
    match = [["gh", "codespace", "delete", "--codespace", "CODESPACE"]],
    not_match = [["gh", "codespace", "list"]],
)
prefix_rule(
    pattern = ["gh", "repo", "deploy-key", "delete"],
    decision = "forbidden",
    justification = "Deploy key 削除は影響が大きく不可逆なため禁止。",
    match = [["gh", "repo", "deploy-key", "delete", "123"]],
    not_match = [["gh", "repo", "deploy-key", "list"]],
)
prefix_rule(
    pattern = ["gh", "repo", "autolink", "delete"],
    decision = "forbidden",
    justification = "Autolink 削除は設定変更のため禁止。",
    match = [["gh", "repo", "autolink", "delete", "1"]],
    not_match = [["gh", "repo", "autolink", "list"]],
)
prefix_rule(
    pattern = ["gh", "ssh-key", "delete"],
    decision = "forbidden",
    justification = "SSH key 削除は不可逆なため禁止。",
    match = [["gh", "ssh-key", "delete", "123"]],
    not_match = [["gh", "ssh-key", "list"]],
)
prefix_rule(
    pattern = ["gh", "gpg-key", "delete"],
    decision = "forbidden",
    justification = "GPG key 削除は不可逆なため禁止。",
    match = [["gh", "gpg-key", "delete", "123"]],
    not_match = [["gh", "gpg-key", "list"]],
)
