# Q-002: unsafe な名前（例: `:` を含む等）を検出したときの扱い

## 決定（ユーザー回答）
- 決定: **A（自動で安全な名前へ変換して続行）**
- 追加: 変換が発生した場合は **stderr に警告を出す（Yes）**

## このシートの目的
Q-001 で `<project_dir>` の決め方を選ぶとしても、現実には “そのまま使うと壊れる/危ない” 名前があり得ます。  
Q-002 は、そのときに **自動変換して続行するか / 明示エラーで止めるか**を決める質問です。

## 何が unsafe になり得るか（具体）
### 1) Docker Compose の volumes（短い `host:container` 記法）の制約
現状の `docker-compose.yml` は volumes を文字列で書いています（`docker-compose.yml:23`）。

```yaml
- ${SOURCE_PATH}:${PRODUCT_WORK_DIR}
```

この形式は “区切り文字として `:` を使う” ため、**`PRODUCT_WORK_DIR` に `:` が含まれると壊れる**可能性があります。  
（macOS のディレクトリ名には `:` を含められるため、理論上起こり得ます）

### 2) bash での取り回し・ログ出力
`<project_dir>` はログやステータスにも出ます。  
改行や制御文字が混ざると、ログが読みにくくなる／表示崩れ／意図しない解釈のリスクがあります。

### 3) ツール側の “パス正規化” や期待
一部ツールは `realpath` を取ったり、想定外の文字で挙動が変わることがあります。  
“完全に何でもOK” を目標にすると、実装とテストが重くなりやすいです。

## 選択肢
### 選択肢A: 自動で安全な名前へ変換して続行（推奨）
方針:
- unsafe を検出したら `<project_dir>` を slug/hash 等へフォールバックして起動を続行
- 変換が起きたことは stderr へ注意として出してもよい（stdout 契約を壊さない範囲で）

Pros:
- UX が良い（突然 “起動できない” になりにくい）
- スクリプト/自動化にも優しい（失敗率を下げる）

Cons:
- ホスト名と見た目がズレる（ただし Q-001 で C を選べば一貫する）
- 変換規則をドキュメント化しないと混乱する

### 選択肢B: 明確なエラーで止める（厳格）
方針:
- unsafe を検出したら起動を拒否し、理由と回避策を提示（例: “別名でマウントするオプションを使ってください” 等）

Pros:
- 変換の驚きがない（いつも見た目が一定）
- “問題ある名前を許さない” ので設計がシンプル

Cons:
- 実運用で詰まりやすい（ユーザーが毎回対処が必要）
- STT/自動化/CI で事故が増える可能性

## 追加の重要論点: compose を long syntax にすると unsafe を減らせる
compose の volumes は long syntax にすると `:` 区切り問題を避けられます（将来の設計案）。

```yaml
volumes:
  - type: bind
    source: ${SOURCE_PATH}
    target: ${PRODUCT_WORK_DIR}
```

これにより、少なくとも “`:` を含むと壊れる” 類のリスクは大幅に下がります。  
（ただし改行や制御文字などは別問題なので、最低限のサニタイズは依然として必要です）

## 私の分析（推奨案）
推奨: **選択肢A（自動変換）**

理由:
- 今回の目的は “混線を避ける” であり、起動不能にしてしまうと導入コストが上がります。
- Q-001 で C（slug+hash）を採用すれば、unsafe の大半はそもそも回避できます。

併せて推奨（設計で検討したい）:
- `docker-compose.yml` の volumes を long syntax に移行する（破壊的ではないが、変更範囲は増える）
  - これにより “`:` が含まれると壊れる” を仕様レベルで消しやすいです。

## 決めたいこと（あなたに聞きたいこと）
Q-002（回答フォーマット）:
- unsafe を検出したらどうしますか？
  - A: 自動変換して続行（推奨）
  - B: エラーで止める

もし A を選ぶ場合、次も確認したいです（任意）:
- 変換が起きたことを stderr に警告として出してよいですか？（Yes/No）
