# Q-003: 互換性と移行（`/srv/mount` 直下前提を壊してよいか）

## 決定（ユーザー回答）
- 決定: **A（破壊的変更 OK）**

## このシートの目的
To-Be ではコンテナ内のルートが `/srv/mount/<project_dir>` になります。  
これは “`/srv/mount` がプロジェクトルート” という前提を変えるため、互換性と移行方針を明確に決める必要があります。

## 変わること（影響点の棚卸し）
### 1) コンテナ内パス（最重要）
- As-Is: プロジェクトルート = `/srv/mount`
- To-Be: プロジェクトルート = `/srv/mount/<project_dir>`

影響:
- 手動手順（`cd /srv/mount` 前提）
- スクリプト（固定パス参照）
- “プロジェクト名” 判定（今回の主題）

### 2) Codex Trust キー（.agent-home が共有である点が重要）
`sandbox codex` は Trust 判定に “コンテナ内パス” を使います（`/srv/mount/...`）。

影響:
- 既存の Trust（もし `/srv/mount` などで登録されていた場合）は、新しい `/srv/mount/<project_dir>/...` では効かない
- そのため、初回は bootstrap になりやすく、**再 Trust が必要**になる可能性がある

※これは破壊的変更であり得ますが、今回の目的（混線回避）と表裏一体です。

### 3) テスト期待値
現状テストは `/srv/mount` 直書き期待が多いです（例: `tests/sandbox_cli.test.sh`）。
To-Be では `/srv/mount/<project_dir>` を前提に更新が必要になります。

### 4) ドキュメント/ガイド
docs があれば `/srv/mount` 前提を更新する必要があります（現状 docs は多くないが、増えるほど影響増）。

## 選択肢
### 選択肢A: 破壊的変更 OK（推奨）
方針:
- 以後の正は `/srv/mount/<project_dir>` とし、`/srv/mount` をプロジェクトルートとして扱わない
- 必要な対応は “移行メモ” と “テスト更新” と “再 Trust の案内” に寄せる

Pros:
- 実装/仕様が単純で堅牢（ブレが少ない）
- 目的（混線回避）に最短で効く
- 互換レイヤが原因の “分岐バグ” を避けられる

Cons:
- 既存手順/スクリプトが壊れる可能性がある
- Trust は基本的にやり直しになる可能性がある

### 選択肢B: 互換レイヤが必要（保守的）
候補案（例）:
- 旧パス `/srv/mount` から新パスへの symlink を用意する
- あるいは “旧スタイル/新スタイル” を切り替える設定（env/オプション）を導入する

Pros:
- 既存スクリプトが壊れにくい

Cons:
- 実装とテストが複雑化しやすい（分岐が増える）
- “realpath を取ると結局同じ扱い” などで、ログ混線が完全に直らない可能性もある
- 将来の保守コストが増える

## 私の分析（推奨案）
推奨: **選択肢A（破壊的変更 OK）**

理由:
- 今回の問題は “識別子が固定/衝突して混線する” ことなので、互換レイヤは **再び混線の入口** になり得ます。
- Bash/compose という周辺条件を考えると、分岐の少ない仕様にした方が安全です。

現実的な移行ガイド（A を選ぶ場合の想定）:
- “プロジェクトルートは `$PRODUCT_WORK_DIR` を見てください” を推奨導線にする
- `sandbox codex` は初回 bootstrap → Trust → 再実行、の流れを明記する
- 必要なら `sandbox status` の出力に `container_workdir` を追加して観測しやすくする（※これは設計/実装で検討）

## 決めたいこと（あなたに聞きたいこと）
Q-003（回答フォーマット）:
- 互換性はどちらを採用しますか？
  - A: 破壊的変更 OK（推奨）
  - B: 互換レイヤが必要

もし B の場合、どの互換が必須か教えてください（例: “既存の `/srv/mount` 固定パス参照スクリプトが多数ある” など）。
