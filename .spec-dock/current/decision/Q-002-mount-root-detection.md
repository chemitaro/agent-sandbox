# Q-002: git worktree 対応の “マウント親（mount root）” をどう決めるか

## この質問の意図
git worktree を使うと、同一リポジトリの複数の作業ディレクトリ（worktree）が **別パス** に存在します。  
この機能で「worktree 全体を包含するように親ディレクトリをマウント」したい場合、`--mount-root` 省略時の自動決定が論点になります。

自動決定を誤ると：
- 必要な worktree がコンテナから見えない（作業が詰む）
- 逆に、意図せず広いディレクトリ（例: `$HOME` 直下）をマウントしてしまう（セキュリティ/誤操作のリスク）

よって「便利さ」と「安全さ」のバランスをどこに置くかを決める質問です。

## 既存実装（As-Is）との関係
現状は `sandbox.config` の `SOURCE_PATH` が mount root です。  
今回の拡張では `SOURCE_PATH` を「動的に決定」できる必要がありますが、**既存の `sandbox.config` 運用も残す** 方針なので、

- 既存: `sandbox.config` に `SOURCE_PATH` 明示（固定運用）
- 新機能: `--mount-root` 省略時に “安全な” 推定

の二系統を共存させるのが自然です。

## 選択肢

### A) 自動推定しない（`--mount-root` 指定必須）
**定義**: worktree を包含したいケースを含め、親は常に人間が指定する。

**メリット**
- 推定ミスが起きない（仕様が単純・事故が少ない）
- 実装・テストが最短になる

**デメリット**
- UX が悪化: 毎回 `--mount-root` を意識する必要がある
- 「パスを指定しない場合は PWD をマウント」という要望から逸れる（少なくとも worktree を満たすには追加指定が必要）

**向いているケース**
- セキュリティ優先で “便利さは二の次” の運用
- ユーザーが全員 git/worktree に慣れているチーム

---

### B) 自動推定する（ただしガード付き）
**定義**:
1. `--mount-root` が指定されていればそれを採用  
2. 未指定なら `--path`（省略時 PWD）から git 情報を読み、候補を計算  
3. “広すぎる” 場合は安全側に倒す（拒否 or フォールバック）

**メリット**
- 通常はゼロ設定で動く（`agent-sandbox up` だけでそれっぽくなる）
- worktree でも “だいたい期待通り” の親が選ばれる
- ガードにより事故（意図しない広いマウント）を抑えられる

**デメリット**
- 実装が増える（git コマンド呼び出し・判定ロジック）
- “自動推定が何をしたか” をユーザーに見せないと混乱する（ログ/表示が必要）

**向いているケース**
- 今回の要件（利便性と汎用性）を重視する場合

---

## 推奨案（私のおすすめ）
**推奨: B（自動推定 + ガード + 明示上書き）**

### 推奨理由
- “任意ディレクトリから起動できる” ツールにしたいなら、毎回親を指定させるのは障壁が大きいです。
- ただし安全性を落とせないので、推定ロジックに **ガード**（拒否/フォールバック）が必要です。
- さらに、推定ロジックが不完全でも運用が止まらないように `--mount-root` 上書きを用意します（Q-001 と整合）。

## 推定ロジック案（たたき台）
以下は “議論用の案” です。最終決定は requirement/design で固定します。

### 候補1: git worktree 共通親（worktree を包含）
1. `git -C <workdir> worktree list --porcelain` を取得  
2. 全 worktree のパス集合 `W = {w1, w2, ...}` を得る  
3. `W` の **最長共通プレフィックス（ディレクトリ単位）** を common parent として計算  
4. ガード:
   - common parent が `/` に近い（例: 深さが浅い、`$HOME` と同一等）なら拒否 or フォールバック

**Pros**: あなたの要件（worktree 全体を包含）に最も忠実。  
**Cons**: worktree が散らばっていると common parent が過度に広くなり得る。

### 候補2: `git rev-parse --show-toplevel`（単一 repo root）
1. `git -C <workdir> rev-parse --show-toplevel` を mount root にする

**Pros**: 安全で単純。  
**Cons**: worktree が repo root 外にある場合、包含できない。

### 候補3: “安全な方を採用” ハイブリッド
1. まず候補1（共通親）を計算  
2. ガードで “広すぎる” 場合は候補2（toplevel）へフォールバック  
3. それでも足りない場合は、ユーザーに `--mount-root` 指定を促す（エラー or 警告）

**Pros**: UX と安全性のバランスが良い。  
**Cons**: 仕様説明が増える（だがログ出せば納得しやすい）。

## ガード条件（例）
これは “TBD” で、あなたと合意して固定したい部分です。

- common parent が `$HOME` と同じ、またはその直下すぎる場合は拒否
- common parent の深さ（パス要素数）が一定以下なら拒否（例: `/Users/<name>` までしか無い等）
- workdir と mount root の距離（相対パス）が極端に深い/広い場合は警告

## 観測可能な振る舞い（テストに落としやすい形）
- `--mount-root` 指定時は必ずそれが採用される
- `--mount-root` 未指定で git repo の場合:
  - 推定 mount root が表示される（ログ/出力）
  - ガードに引っかかった場合はフォールバック/エラーが明確に出る
- git repo でない場合:
  - mount root = `--path`（省略時 PWD）になる（または親を1段上げない）

## あなたが回答しやすい確認ポイント
1. 自動推定が “広すぎる” と判断したときはどれが良いですか？
   - A: エラーにして止める（必ず `--mount-root` 指定させる）
   - B: repo root にフォールバックして続行（不足する可能性は警告）
   - C: PWD を mount root にして続行（worktree包含は諦めるが安全寄り）
2. “広すぎる” の基準として避けたいものは？
   - `$HOME` 直下
   - `/Users/<name>` 直下
   - `/` 直下

