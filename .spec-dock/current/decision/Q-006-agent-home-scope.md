# Q-006: `.agent-home`（CLI設定・キャッシュ）を共有するか分離するか

## この質問の意図
この repo は `.agent-home/` をホスト側に持ち、各種エージェントの設定や履歴を bind mount で永続化しています（`README.md` / `docker-compose.yml`）。

複数コンテナを並行で動かすと、`.agent-home` をどう扱うかで体験が変わります。

- 共有すると: すべてのコンテナで同じ設定/履歴を使う（便利だが混ざる）
- 分離すると: コンテナ（またはプロジェクト）ごとに設定/履歴を分けられる（安全だが増える）

## 選択肢

### A) 既存通り共有する（デフォルト）
**メリット**
- 実装・運用がそのまま（変更が最小）
- どのコンテナからでも同じ認証/設定が使える（切り替えが楽）
- ディスク消費が増えにくい

**デメリット**
- プロジェクト間で履歴や設定が混ざる可能性
  - 例: ツールの “直近プロジェクト” 設定、キャッシュ、補完データ等
- 何か壊れたときに影響範囲が広い

---

### B) コンテナ（またはworkdir）ごとに分離する（オプション）
**メリット**
- プロジェクト/作業単位で完全に独立した状態を作れる
- 事故（設定破損、履歴混入）の影響が局所化する

**デメリット**
- 実装が増える（`.agent-home` のパスをインスタンスごとに切り替える必要）
- ディスク使用量が増える（キャッシュが増殖）
- 初回起動が遅くなる（各インスタンスで設定生成が走る）

---

## 推奨案（私のおすすめ）
**推奨: A をデフォルト、B は将来のオプション（またはスコープ外）**

### 推奨理由
- 今回の “動的マウント + 複数コンテナ” だけでも変更範囲が大きいです。まずは **最低限の差分で価値を出す** のが安全です。
- `.agent-home` 分離は要望として合理的ですが、設計/テスト観点が増えます（AC/EC が増える）。
- ただし将来に備え、インターフェースとして `--agent-home <path>` や `--isolate-agent-home` を追加できる設計余地は残すのが良いです。

## 実装メモ（将来オプション化するなら）
インスタンスID（Q-004のhash等）を使って：
- `.agent-home/instances/<id>/.claude`
- `.agent-home/instances/<id>/.codex`
- …
に振り分け、`docker-compose` の volume マッピングを差し替える必要があります。

その場合、`docker-compose.yml` を固定のままにするなら
- override compose を生成する
または
- `.env` で volume のホスト側パスを変数化する
といった追加設計が必要になります。

## あなたが回答しやすい確認ポイント
- “プロジェクト間で履歴/設定が混ざるのは困る” 度合いはどれくらいですか？
  - A: ほぼ困らない（共有でOK）
  - B: たまに困る（後でオプションで欲しい）
  - C: かなり困る（最初から分離が必須）

