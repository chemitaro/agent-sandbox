---
種別: 設計補助資料（意思決定レポート）
機能ID: "FEAT-005"
論点ID: "design.md Q-003"
論点名: "mount-root 自動推定が“広すぎる”場合のガード"
作成者: "Codex CLI"
最終更新: "2026-01-22"
関連: ["../design.md", "../requirement.md"]
---

# Q-003: mount-root 自動推定が “広すぎる” 場合のガード

## 0. この論点は何を決めるか（結論の影響）
引数なし起動（AC-001）では、git worktree 情報から `mount-root` を自動推定します。  
しかし、worktree が極端に離れた場所にあると、最小共通祖先（LCA）が `/Users` や `$HOME` など **過度に広いディレクトリ**になり得ます。

この論点は、事故防止のために **自動推定した `mount-root` を拒否する基準（ガード）**を固定します。

---

## 1. “広すぎる” が問題になる理由（何が起きるか）
1) **安全性**:
   - 本来対象外のディレクトリまでコンテナに見える（意図しない情報露出）。
2) **性能/安定性**:
   - 大きすぎる bind mount はファイル走査・watch・検索で重くなり得る。
3) **意図しない操作**:
   - エージェントが誤って別プロジェクトのファイルも読み書きできる。

要件として、広すぎる場合は無理に包含せず **エラーで拒否**する（AC-005, MUST NOT）ため、  
ガードは “安全側に倒す” のが基本方針です。

---

## 2. 判断基準（評価軸）
1) **事故防止の強さ**: 明らかに危険な範囲を確実に弾けるか  
2) **誤検知の少なさ**: 通常運用（worktree を近傍に置く）を邪魔しないか  
3) **実装の堅牢さ**: Bash でパスの境界（`/UsersX` など）を誤判定しない設計か  
4) **説明可能性**: 失敗時にユーザーが理解しやすく、`--mount-root` で回避できるか  

---

## 3. 選択肢

### 選択肢A: 禁止パス（ブラックリスト）だけで拒否
#### 3.1 例（禁止候補）
- `/`
- `/Users`
- `$HOME`（例: `/Users/iwasawayuuta`）

#### 3.2 メリット
- 直感的で説明しやすい。
- 実装が簡単（誤判定が起きにくい）。
- 最悪級の事故（`/` や `/Users` を mount）を確実に防げる。

#### 3.3 デメリット / リスク
- “禁止パス” に該当しないが **まだ広すぎる**（例: `$HOME/workspace`）ケースを弾けない。
- チーム/環境により “危険と感じる境界” が変わり、ルールが弱くなりがち。

---

### 選択肢B: `git root` から上に遡る階層数（MAX_UP_LEVEL）だけで拒否
#### 3.4 具体像
- `repo_root = git rev-parse --show-toplevel`
- `mount_root = LCA(all worktree paths)`
- `repo_root` から `mount_root` へ **何階層上がったか**を `up_levels` として計算
- `up_levels > MAX_UP_LEVEL` なら拒否

#### 3.5 メリット
- “広さ” を **相対的に**測れる（レイアウトが深い/浅いの差に対応しやすい）。
- 通常運用（main と worktree が近い）なら小さい値で収まることが多い。

#### 3.6 デメリット / リスク
- 禁止パスが無いと、レイアウト次第で `$HOME` などが通る可能性がある。
- 値のチューニングが必要（小さすぎると誤検知、大きすぎると事故）。

---

### 選択肢C（推奨）: A+B の組み合わせ
#### 3.7 メリット
- “絶対に危険” な範囲を A で確実に落とし、B で “まだ広い” も落とせる。
- 説明もしやすい（「ここまでは禁止」「それ以外でも上に上がりすぎたら拒否」）。

#### 3.8 デメリット
- ルールが2本になる分、仕様として文章化が必要（ただし一度決めれば固定化できる）。

---

## 4. 推奨案と、推奨している理由
**推奨は C（禁止パス + MAX_UP_LEVEL）**です。

理由:
- 要件の主眼が “事故防止” であり、**単一ルールより二重ガードの方が安全側**。
- `git worktree` の配置は「近いはず」という運用前提があるため、MAX_UP_LEVEL を小さくしても成立しやすい。
- 失敗しても `--mount-root` 明示で回避でき、運用として破綻しにくい。

---

## 5. 推奨の初期値（たたき台）
環境例（よくあるパターン）:
- main: `/Users/<u>/workspace/product/repo`
- worktree: `/Users/<u>/workspace/product/repo-wt/feature-x`
  - LCA: `/Users/<u>/workspace/product`（repo_root から上に 1〜2）

初期値案:
- 禁止パス: `/`, `$HOME`, `/Users`, `/home`, `/Volumes`, `/mnt`, `/media`（完全一致）
- `MAX_UP_LEVEL=1`

※「worktree を別階層に置く」運用があるなら、`MAX_UP_LEVEL` を上げる必要があります。  
ただし値を上げるほど事故余地も増えるため、本タスクでは **1 を上限**とし、超える場合は明示指定で対応します。

---

## 6. あなたが回答するときの項目（コピペ用）
- 回答: A / B / C
- （B or C の場合）`MAX_UP_LEVEL` の希望値: 1 / 2 / 3 / その他（___）
- （A or C の場合）禁止パスに追加したいもの: なし / あり（___）

---

## 7. 決定（ユーザー回答の反映）
- 決定: C（A+B）
- `MAX_UP_LEVEL`: 1
- 禁止パス: 実装側で提案し、要件/設計に反映（完全一致）
- 補足:
  - bind mount 自体は “コピー” ではないため、マウント範囲が広いこと自体がホストのディスク使用量を直接増やすわけではありません。
  - ただし探索・インデックス・キャッシュ等の副作用はあり得るため、事故防止としてガードで狭めます。
