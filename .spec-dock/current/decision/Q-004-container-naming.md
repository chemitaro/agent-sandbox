# Q-004: コンテナ名（衝突回避ID）をどう決めるか

## この質問の意図
複数コンテナを並行起動するには、**コンテナ名の衝突回避** が必須です。  
また、Compose の “プロジェクト名”・ネットワーク名なども衝突しうるため、実質的には以下を安定に一意化したいです。

- `container_name`（`docker ps` で見える名前）
- Compose project name（`name:` で設定している値）

現状の `scripts/generate-env.sh` は `SOURCE_PATH` から `CONTAINER_NAME` を生成し、長さ 63 で切っています。  
しかし今回の要件では `SOURCE_PATH`（mount root）と `--path`（workdir）が分離されるため、**両方を材料にしないと衝突** が起こり得ます。

## 選択肢

### A) mount root の絶対パスのみを材料にする
**メリット**
- “マウント親” が同じなら常に同じコンテナ、という挙動が自然（Q-003でB寄り）
- 実装が単純（既存の `SOURCE_PATH → CONTAINER_NAME` に近い）

**デメリット**
- 同じ mount root の下で複数 worktree を並行に動かしたい場合に衝突する（Q-003でAなら不一致）

---

### B) workdir の絶対パスのみを材料にする
**メリット**
- worktreeごとに一意になりやすい（Q-003でA寄り）
- “どこから起動したか” と対応づけやすい

**デメリット**
- mount root を大きくしても、コンテナ名からは分かりにくい（運用で迷いやすい）
- workdir が深いと長くなりがち（切り詰めが必要）

---

### C) mount root + workdir を両方材料にする（手動 `--name` で上書き可）
**メリット**
- 仕様上の衝突を最小化できる（workdir並行 + mount root 分離に強い）
- “どの親をマウントして、どこで作業するか” が一意に決まる

**デメリット**
- 文字列が長くなりがち（必ず短縮/ハッシュが必要）

---

## 推奨案（私のおすすめ）
**推奨: C（mount root + workdir + ハッシュ短縮 + `--name` 上書き）**

### 推奨理由（具体）
- あなたの要件は「親は包含」「初期ディレクトリは PWD/指定」かつ「複数コンテナ並行」です。  
  このとき衝突を避ける最小情報は `mount root` と `workdir` の組です。
- “パス文字列そのまま” だと長すぎて不安定なので、**可読部分 + 安定ハッシュ** が現実的です。

## 命名方式の具体案（たたき台）
### 方式1: 可読prefix + short hash（おすすめ）
- 可読prefix: `basename(workdir)` または `basename(mount root)` を sanitize
- hash: `sha256(mount_root + \"|\" + workdir)` の先頭 8〜12 文字

例:
- `agent-sandbox-feature-a-3f12a9c4`
- `agent-sandbox-backend-api-8c01d2e7`

**Pros**: 読みやすく、衝突しにくい。  
**Cons**: ハッシュがあるため “完全に人間だけで復元” はできない（ただしログに出せば解決）。

### 方式2: パス文字列の一部を連結（現状方式の延長）
- `~/workspace/foo/bar` → `workspace-foo-bar` など

**Pros**: ハッシュ不要。  
**Cons**: 長さ制限で切ると衝突しやすい（今回の要件では危険）。

## 追加要件として固定したい点（TBD）
- `--name` で完全上書きを許可するか？
  - 許可すると運用自由度が上がるが、衝突時の責任はユーザー側になる
- ハッシュ長は何文字にするか？
  - 8文字: そこそこ安全で短い
  - 12文字: より安全だが少し長い
- 名前の最大長は何を上限にするか？
  - 既存スクリプトは 63 に切っている（踏襲すると安全）

## 観測可能な振る舞い（テストに落とす観点）
- 同一（mount root, workdir）で起動すると同名コンテナに再接続する
- 異なる（mount root, workdir）で起動すると異なるコンテナ名になる
- `--name` 指定時は、生成名ではなく指定名が使われる

## あなたが回答しやすい確認ポイント
1. 人間が `docker ps` で見たとき、どれが大事ですか？
   - A: “作業ディレクトリ名が見える” が最重要
   - B: “親ディレクトリ名が見える” が最重要
2. `--name` は必要ですか？
   - 必須（運用で手動命名したい）
   - なくても良い（原則自動で十分）

