# Q-003: 複数コンテナ起動の “コンテナ単位” をどうするか

## この質問の意図
要望として「1つのツールで複数の Docker コンテナを立ち上げ可能にしたい」があります。  
このとき **何をキーにコンテナを分けるか**（= コンテナ単位）を決めると、以下が一気に決まります。

- どの程度 “並行作業” がしやすいか（worktreeごとに独立して起動できるか）
- 既存の `make up` が `down` を挟むなど、破壊的な操作をどう扱うか
- `.env` を1つにするか、インスタンスごとに持つか（運用・実装複雑度）
- コンテナ名衝突の避け方（Q-004）

## 前提（この repo の現状）
- `docker-compose.yml` は `container_name: ${CONTAINER_NAME}` を使い、`.env` の `CONTAINER_NAME` に依存します。
- `scripts/generate-env.sh` は `.env` を **単一ファイルとして上書き生成** します。
- `make up` は `docker-compose down` を実行してから `up -d` します（単一プロジェクト運用の前提）。

複数コンテナを同時運用するには、`.env` も “インスタンスごと” に分ける/上書きしない、あるいは `docker-compose` 呼び出しを “インスタンス文脈” に閉じる必要があります。

## 選択肢

### A) workdir（= 起点ディレクトリ）ごとに 1コンテナ
**定義**: `--path`（省略時 PWD）単位でコンテナを分ける。同じ mount root を共有することはあっても、コンテナは分ける。

**メリット**
- worktree ごとに独立起動しやすい（最も要件に近い）
- “今どの作業をしているか” がコンテナ単位で明確（切り替えが楽）
- 片方の作業でコマンドを暴走させても、別コンテナに影響が出にくい（心理的安全）

**デメリット**
- コンテナ数が増える（メモリ/ディスク/管理コスト）
- `.agent-home` を共有する場合、設定は共有のまま（完全分離したいなら Q-006 で追加要件）

---

### B) mount root（= マウント親）ごとに 1コンテナ（workdir は exec 時に切り替え）
**定義**: mount root ごとにコンテナは1つ。worktree を切り替えるときは `docker-compose exec -w ...` や tmux セッションで `cd` して作業する。

**メリット**
- コンテナ数が少なく済む（リソース効率）
- mount root を共有する複数 worktree を “同じ環境” で扱える

**デメリット**
- “複数コンテナを立ち上げる” 要望とズレる可能性
- worktreeごとに完全に独立したセッションを切りたい場合、同一コンテナ内での工夫が必要（tmux/複数プロセス）
- `working_dir` の概念が弱くなり、UX設計が少し難しい

---

## 推奨案（私のおすすめ）
**推奨: A（workdir ごとに 1コンテナ）**

### 推奨理由
- “worktreeごとに並行でエージェント稼働” を一番自然に満たします。
- コンテナのキーが `--path` で明確になるため、コンテナ名生成（Q-004）・ログ表示・削除（stop/down）などの運用がわかりやすいです。
- mount root を大きくしたい要件は、**Aでも mount root は共通にできる** ため矛盾しません（同じ親を複数コンテナがマウントしてよい）。

## 仕様に落とすときの観測可能な振る舞い（案）
- 同一 `--path`（同一 workdir）で `up` すると、同じコンテナに再接続する（重複起動しない）
- 異なる `--path` で `up` すると、別コンテナが起動し、並行稼働できる
- 既存の `make start`（単一 `.env`）は従来通り動く（互換性）

## 実装メモ（この repo への影響）
Aを採用すると、原則 `.env` を “インスタンスごと” に分離し、`docker-compose --env-file <instance.env>` のように実行する設計が自然です。

- `scripts/generate-env.sh` を「任意の出力先 `.env` を生成できる」ように拡張
- `make up` のような “down してから up” は、既存運用として残す（互換）か、動的インスタンス用には別コマンドにする

## あなたが回答しやすい確認ポイント
- 「worktreeごとに完全に別プロセス/別ツールを走らせたい」→ A が強い
- 「コンテナは増やしたくない。切り替えは tmux で良い」→ B も検討余地

